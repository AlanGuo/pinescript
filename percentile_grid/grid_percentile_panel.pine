//@version=6
indicator("BTC 日K分位数 (附图)", overlay = false, max_bars_back = 5000)

//=== 参数，与策略脚本保持一致即可 ===//
windowDays = input.int(365, "日K分位数窗口 (天)", minval = 60, maxval = 2000)

//=== 在日线级别计算分位数 ===//
f_daily_percentile(int length) =>
    float pct = na
    if bar_index >= length
        float cnt   = 0.0
        float valid = 0.0
        for i = 0 to length - 1
            float v = close[i]
            if not na(v)
                valid += 1.0
                if v <= close
                    cnt += 1.0
        pct := valid > 0 ? 100.0 * cnt / valid : na
    pct

// 把“日线分位数”拉到当前周期
p = request.security(
     syminfo.tickerid,
     "D",
     f_daily_percentile(windowDays),
     barmerge.gaps_off,
     barmerge.lookahead_off)

//=== 画图展示 ===//
plot(p, title = "日K 分位数 (0-100)", color = color.new(color.blue, 0))
hline(10,  "P10", color = color.new(color.green, 60), linestyle = hline.style_dotted)
hline(50,  "P50", color = color.new(color.gray, 60),  linestyle = hline.style_dotted)
hline(90,  "P90", color = color.new(color.red, 60),   linestyle = hline.style_dotted)
